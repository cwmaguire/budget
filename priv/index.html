<html>
  <script language="JavaScript">
    function q(){
      console.log("Running function q");
      var oldScript = document.getElementById("fetch");
      var fromDate = get_val("fromDateText");
      var toDate = get_val("toDateText");
      console.log("From date: " + fromDate);
      console.log("To date: " + toDate);
      if(oldScript){
        oldScript.remove();
      }
      var s = document.createElement("script");
      s.src = "http://localhost:8080/?callback=load&from="
        + fromDate
        + "&to="
        + toDate;
      s.id = "fetch";

      s.onload = function() {
        loadTable();
      };

      document.body.appendChild(s);

    }

    function loadTable(){
      var records = load();
      if(records.length == 0){
        return;
      }

      var oldTable = document.getElementById("table1");
      if(oldTable){
        oldTable.remove();
      }
      var table = document.createElement("table");
      table.id = "table1";

      var header = table.createTHead();
      var row = header.insertRow(0);
      var i = 0;
      var cell;
      var rec = records[0];
      for (k in rec){
        if(k == "id"){
          continue;
        }
        cell = row.insertCell(i);
        cell.innerHTML = "" + k;
        cell.bgColor = "#D0D0D0";
        i++;
      }

      records.forEach(tableWriter(table));
      document.body.appendChild(table);
    }

    function tableWriter(table){
      return function(obj){
               var row = table.insertRow();
               row.id = obj["id"];
               var cell;
               var val;
               for (var k in obj){
                 val = obj[k];
                 if(k == "id"){
                   continue;
                 } else if((k == "date" || k == "posted") && obj[k]){
                   val = obj[k].split("T")[0];
                 }
                 cell = row.insertCell(row.cells.length);
                 cell.innerHTML = val;
               }
               row.style.cursor = "pointer";
               row.addEventListener("mouseover", row_mouse_over);
               row.addEventListener("mouseout", row_mouse_out);
             }
    }

    function get_val(Id){
      var element = document.getElementById(Id);
      return element.value;
    }

    function row_mouse_over(event){
      cell = event.target;
      cell.parentElement.style.backgroundColor = "#9090FF";
    }

    function row_mouse_out(event){
      cell = event.target;
      cell.parentElement.style.backgroundColor = "#FFFFFF";
    }

  </script>
  <body>
    <table>
      <tr>
        <td>
          From:
        </td>
        <td>
          <input id="fromDateText" type="text" value="2018-10-01">
        </td>
      </tr>
      <tr>
        <td>
          To:
        </td>
        <td>
          <input id="toDateText" type="text" value="2018-10-03">
        </td>
      </tr>
    </table>
    <br>
    <button display="query" text="query" onclick="q();">Query</button>
  </body>
</html>
